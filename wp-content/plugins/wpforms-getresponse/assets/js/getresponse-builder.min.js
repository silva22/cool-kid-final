"use strict";WPForms.Admin.Builder.Providers.GetResponse=WPForms.Admin.Builder.Providers.GetResponse||function(e,n,r){var t={$providerHolder:null,$providerConnections:null,config:{templates:["wpforms-getresponse_v3-builder-content-connection","wpforms-getresponse_v3-builder-content-connection-subscriber-subscribe","wpforms-getresponse_v3-builder-content-connection-subscriber-unsubscribe","wpforms-getresponse_v3-builder-content-connection-error","wpforms-getresponse_v3-builder-content-connection-lock","wpforms-getresponse_v3-builder-content-connection-conditionals"]},replaceConnectionIds:function(n,e){e.find("input, textarea, select, label").each(function(){var e=r(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,n)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,n)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,n)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,n))})},connectionAccountExists:function(e,n){return!_.isEmpty(n)&&(!!_.isEmpty(e)||_.has(n,e))}},c={provider:"getresponse_v3",Providers:{},Templates:{},Cache:{},isReady:!1,init:function(){"providers"===wpf.getQueryString("view")&&r("#wpforms-panel-providers").on("WPForms.Admin.Builder.Providers.ready",c.ready),r(e).on("wpformsPanelSwitched",function(e,n){"providers"===n&&c.ready()})},ready:function(){c.isReady||(c.Providers=WPForms.Admin.Builder.Providers,c.Templates=WPForms.Admin.Builder.Templates,c.Cache=c.Providers.cache,t.$providerHolder=c.Providers.getProviderHolder(c.provider),t.$providerConnections=t.$providerHolder.find(".wpforms-builder-provider-connections"),c.Templates.add(t.config.templates),c.Providers.ui.account.registerAddHandler(c.provider,c.processAccountAdd),c.bindUIActions(),c.bindTriggers(),c.processInitial(),c.isReady=!0)},bindUIActions:function(){t.$providerHolder.on("connectionCreate",c.connection.callbacks.create).on("connectionDelete",c.connection.callbacks.delete).on("change",".js-wpforms-builder-getresponse-provider-connection-account",c.ui.account.changeCallback).on("change",".js-wpforms-builder-getresponse-provider-connection-action",c.ui.action.changeCallback).on("input",".js-wpforms-builder-getresponse-provider-tags-new",c.ui.tags.addNewInputCallback).on("input",".js-wpforms-builder-getresponse-provider-cycle-day",c.ui.cycleDay.inputCallback)},bindTriggers:function(){t.$providerConnections.on("connectionsDataLoaded",function(e,n){for(var o in n.connections)_.has(n.connections,o)&&c.connection.callbacks.generate({connection:c.Cache.getById(c.provider,"connections",o),conditional:c.Cache.getById(c.provider,"conditionals",o)})}),t.$providerConnections.on("connectionGenerated",function(e,n){var o=c.connection.getById(n.connection.id);_.has(n.connection,"isNew")&&n.connection.isNew&&t.replaceConnectionIds(n.connection.id,o),r(".js-wpforms-builder-getresponse-provider-connection-action",o).trigger("change",[o])}),t.$providerConnections.on("connectionRendered",function(e,n,o){var i=c.connection.getById(o);t.replaceConnectionIds(o,i),c.mapFields(o,i),c.loadChoicesJS(i)})},processInitial:function(){t.$providerConnections.prepend(c.tmpl.callbacks.commonsHTML()),c.connection.callbacks.dataLoad()},processAccountAdd:function(n){var e=n.$content.find('input[name="apikey"]'),o=n.$content.find(".error"),i=e.val().toString().trim();return _.isEmpty(i)?(o.show(),n.setType("red"),_.isEmpty(i)&&e.addClass("wpforms-error")):(o.hide(),n.setType("blue"),e.removeClass("wpforms-error"),c.Providers.ajax.request(c.provider,{data:{task:"account_save",apikey:i,label:n.$content.find('input[name="label"]').val().toString().trim()}}).done(function(e){!e.success||_.has(e.data,"error")&&!_.isEmpty(e.data.error)?(n.setType("red"),o.html(e.data.error).show()):(t.$providerHolder.find(".wpforms-builder-provider-title-add").toggleClass("hidden"),n.close())})),!1},mapFields:function(e,n){var o=c.Cache.getById(c.provider,"connections",e);_.isEmpty(o)||_.isEmpty(o.fields)||(""!==o.fields.email&&r('select[name="providers['+c.provider+"]["+e+'][fields][email]"]',n).val(o.fields.email),""!==o.fields.name&&r('select[name="providers['+c.provider+"]["+e+'][fields][name]"]',n).val(o.fields.name))},loadChoicesJS:function(e){_.isFunction(n.Choices)&&(e=r(".choicesjs-select",e)).length&&e.each(function(e,n){var n=r(n),o={shouldSort:!1,removeItemButton:!0,callbackOnInit:function(){wpf.initMultipleSelectWithSearch(this)}};void 0===n.data("choicesjs")&&n.data("choicesjs",new Choices(n[0],o))})},connection:{getById:function(e){return t.$providerConnections.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},callbacks:{create:function(e,n){var o=(new Date).getTime().toString(16),n={id:o,name:n,isNew:!0};c.Cache.addTo(c.provider,"connections",o,n),c.connection.callbacks.generate({connection:n})},delete:function(e,n){n.closest(t.$providerHolder).length&&void 0!==(n=n.data("connection_id"))&&c.Cache.deleteFrom(c.provider,"connections",n)},generate:function(n){var e=c.Cache.get(c.provider,"accounts");_.isEmpty(e)?c.Providers.ajax.request(c.provider,{data:{task:"accounts_get"}}).done(function(e){e.success&&_.has(e.data,"accounts")&&(c.Cache.set(c.provider,"accounts",e.data.accounts),c.connection.callbacks.generateItem(n,e.data.accounts))}):c.connection.callbacks.generateItem(n,e)},generateItem:function(e,n){var o=c.Templates.get("wpforms-"+c.provider+"-builder-content-connection"),i=r("#tmpl-wpforms-"+c.provider+"-builder-content-connection-conditionals").length?c.Templates.get("wpforms-"+c.provider+"-builder-content-connection-conditionals"):c.Templates.get("wpforms-providers-builder-content-connection-conditionals"),i=_.has(e.connection,"isNew")&&e.connection.isNew?i():e.conditional;t.connectionAccountExists(e.connection.account_id,n)&&(t.$providerConnections.prepend(o({accounts:n,connection:e.connection,conditional:i,provider:c.provider})),t.$providerConnections.trigger("connectionGenerated",[e]))},dataLoad:function(){c.Providers.ajax.request(c.provider,{data:{task:"connections_get"}}).done(function(e){e.success&&_.has(e.data,"connections")&&(c.Cache.set(c.provider,"connections",jQuery.extend({},e.data.connections)),c.Cache.set(c.provider,"conditionals",jQuery.extend({},e.data.conditionals)),_.isEmpty(e.data.accounts)||c.Cache.set(c.provider,"accounts",jQuery.extend({},e.data.accounts)),t.$providerConnections.trigger("connectionsDataLoaded",[e.data]))})}}},ui:{account:{changeCallback:function(){var e=r(this),n=e.closest(".wpforms-builder-provider-connection"),o=r(".js-wpforms-builder-getresponse-provider-connection-action",n),i=e.val();r(".wpforms-builder-getresponse-provider-actions-data",n).empty(),o.val(""),""===i?o.prop("disabled",!0):(e.removeClass("wpforms-error"),o.prop("disabled",!1))}},action:{changeCallback:function(){var e=r(this),n=e.closest(".wpforms-builder-provider-connection"),o=n.data("connection_id"),i=n.find(".js-wpforms-builder-getresponse-provider-connection-account").val(),t=e.val();e.removeClass("wpforms-error"),r(".wpforms-builder-getresponse-provider-actions-data",n).empty(),c.actions.init({action:t,target:e,account_id:i,connection_id:o})}},tags:{addNewInputCallback:function(){this.value=this.value.replace(/[^_a-zA-Z0-9,]/g,"")}},cycleDay:{inputCallback:function(){this.value=this.value.replace(/[^0-9]/g,"")}}},actions:{init:function(e){switch(e.action){case"subscriber_subscribe":c.actions.subscriber.subscribe.init(e);break;case"subscriber_unsubscribe":c.actions.subscriber.unsubscribe.init(e)}},subscriber:{subscribe:{init:function(e){for(var n,o=["lists","tags","customFields"],i=0;i<o.length;i++)if(n=c.Cache.get(c.provider,o[i]),_.isEmpty(n)||!_.has(n,e.account_id))return void this.request(e);this.render(e)},request:function(n){var o=this;c.Providers.ajax.request(c.provider,{data:{task:"subscribe_data_get",account_id:n.account_id,connection_id:n.connection_id,sources:{lists:!0,tags:!0,customFields:!0}}}).done(function(e){e.success&&!_.isEmpty(e.data)&&(o.cache(e.data,n),o.render(n))})},render:function(e){var n=c.Templates.get("wpforms-"+c.provider+"-builder-content-connection-subscriber-subscribe"),o=c.tmpl.callbacks.customFieldsHTML(e);c.connection.getById(e.connection_id).find(".wpforms-builder-getresponse-provider-actions-data").html(n({connection:c.Cache.getById(c.provider,"connections",e.connection_id),lists:c.Cache.getById(c.provider,"lists",e.account_id),tags:c.Cache.getById(c.provider,"tags",e.account_id),provider:c.provider})+o),t.$providerConnections.trigger("connectionRendered",[c.provider,e.connection_id])},cache:function(o,i){r.each(["lists","tags","customFields"],function(e,n){void 0===c.Cache.get(c.provider,n)&&c.Cache.set(c.provider,n,{}),_.has(o,n)&&c.Cache.addTo(c.provider,n,i.account_id,o[n])})}},unsubscribe:{init:function(e){var n=c.Cache.get(c.provider,"lists");_.isEmpty(n)||!_.has(n,e.account_id)?this.request(e):this.render(e)},request:function(n){var o=this;c.Providers.ajax.request(c.provider,{data:{task:"subscribe_data_get",account_id:n.account_id,connection_id:n.connection_id,sources:{lists:!0}}}).done(function(e){e.success&&!_.isEmpty(e.data)&&(o.cache(e.data,n),o.render(n))})},render:function(e){var n=c.Templates.get("wpforms-getresponse_v3-builder-content-connection-subscriber-unsubscribe");c.connection.getById(e.connection_id).find(".wpforms-builder-getresponse-provider-actions-data").html(n({connection:c.Cache.getById(c.provider,"connections",e.connection_id),lists:c.Cache.getById(c.provider,"lists",e.account_id),provider:c.provider})),t.$providerConnections.trigger("connectionRendered",[c.provider,e.connection_id])},cache:function(e,n){void 0===c.Cache.get(c.provider,"lists")&&c.Cache.set(c.provider,"lists",{}),_.has(e,"lists")&&c.Cache.addTo(c.provider,"lists",n.account_id,e.lists)}}}},tmpl:{callbacks:{commonsHTML:function(){var e=c.Templates.get("wpforms-"+c.provider+"-builder-content-connection-error"),n=c.Templates.get("wpforms-"+c.provider+"-builder-content-connection-lock");return e()+n({provider:c.provider})},customFieldsHTML:function(e){return c.Templates.get("wpforms-providers-builder-content-connection-fields")({connection:c.Cache.getById(c.provider,"connections",e.connection_id),fields:wpf.getFields(),provider:{slug:c.provider,placeholder:wpformsGetResponseBuilderVars.i18n.providerPlaceholder,fields:c.Cache.getById(c.provider,"customFields",e.account_id)}})}}}};return c}(document,window,jQuery),WPForms.Admin.Builder.Providers.GetResponse.init();